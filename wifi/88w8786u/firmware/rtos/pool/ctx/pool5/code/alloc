pool_get_ctx(ctx)
pool5 = ctx->pool5
~ pool5->count == 17 && exit(1F)  # pool is full

_tx_interrupt_control(DISABLE)

node = pool5->free_head
if node != null:
  pool5->free_head = node->next
  node->next = null
}
node->prev = null

if pool5->free_tail == null:
  pool5->free_tail = node
  node->next = null
else:
  pool5->used_tail->prev = node
  node->next = pool5->used_tail
  pool5->used_tail = node
}

pool5->count++

_tx_interrupt_control(ENABLE)

ret = tx_block_pool_create(node, num, desc, mem_size, block_size)
if ret == 0:
  node->num = num
  node->desc = desc
  node->mem_size = mem_size
  node->block_size = block_size
  
  *block = node
  exit(0)
}

# cleanup
_tx_interrupt_control(DISABLE)

pool5->alloc_count--

~ node->prev != null && node->prev->next = node->next || pool5->used_tail = node->next
~ node->next != null && node->next->prev = node->prev

node->prev = null

node->next = pool5->free_head
pool5->free_head = node

_tx_interrupt_control(ENABLE)
exit(ret)
