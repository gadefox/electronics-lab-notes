pool_get_ctx(ctx)
pool = ctx->pool_thread
~ pool->alloc_count == 17 && exit(1F)  # pool is full

_tx_interrupt_control(DISABLE)

node = pool->free_head
if node != null:
  pool->free_head = node->next
  node->next = null
}
node->prev = null

if pool->used_tail == null:
  pool->used_tail = node
  node->next = null
else:
  pool->used_tail->prev = node
  node->next = pool->used_tail
  pool->used_tail = node
}

pool->alloc_count++

_tx_interrupt_control(ENABLE)

ret = tx_thread_create(node, param2, stack_size, priority, name, entry_func, arg)
if ret == 0:
  memcpy(node->name, name, 8)
  node->active = true

  tx_thread_resume(node)
  
  *out = node
  exit(0)
}

# cleanup
_tx_interrupt_control(DISABLE)

pool->alloc_count--

~ node->prev != null && node->prev->next = node->next || pool->used_tail = node->next
~ node->next != null && node->next->prev = node->prev

node->prev = null

node->next = pool->free_head
pool->free_head = node

_tx_interrupt_control(ENABLE)
exit(ret)
